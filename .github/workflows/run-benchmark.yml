name: benchmark
on:
  workflow_call:

jobs:
  benchmark-vs-thresholds:
    # https://runs-on.com/features/custom-runners/
    runs-on:
      labels:
        - runs-on
        - runner=2cpu-4ram
        - run-id=${{ github.run_id }}

    container: swift:noble

    defaults:
      run:
        shell: bash --noprofile --norc -e -u -o pipefail {0}

    steps:
      - name: Configure RunsOn
        uses: runs-on/action@v1

      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: git config --global --add safe.directory "${GITHUB_WORKSPACE}"

      # jemalloc is a dependency of the Benchmarking package
      # actions/cache will detect zstd and will become much faster.
      - name: Install jemalloc, curl, jq and zstd
        run: |
          apt-get update -y
          apt-get install -y libjemalloc-dev curl jq zstd

      - name: Restore .build
        id: restore-cache
        uses: actions/cache/restore@v4
        with:
          path: Benchmarks/.build
          key: "swiftpm-benchmark-build-${{ runner.os }}-${{ github.event.pull_request.base.sha || github.event.after }}"
          restore-keys: "swiftpm-benchmark-build-${{ runner.os }}-"

      - name: Run benchmarks for branch '${{ github.head_ref || github.ref_name }}'
        run: |
          swift package -c release --disable-sandbox \
            --package-path Benchmarks \
            benchmark baseline update \
            '${{ github.head_ref || github.ref_name }}'

      - name: Read benchmark result
        id: read-benchmark
        run: |
          swift package -c release --disable-sandbox \
            --package-path Benchmarks \
            benchmark baseline read \
            '${{ github.head_ref || github.ref_name }}' \
            --no-progress \
            --format markdown \
            >> result.text

          # Read the result to the output of the step
          echo 'result<<EOF' >> "${GITHUB_OUTPUT}"
          cat result.text >> "${GITHUB_OUTPUT}"
          echo 'EOF' >> "${GITHUB_OUTPUT}"

      - name: Compare branch '${{ github.head_ref || github.ref_name }}' against thresholds
        id: compare-benchmark
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          ENCODED_TIMESTAMP=$(date -u +"%Y-%m-%dT%H%%3A%M%%3A%SZ")
          TIMESTAMP_LINK="https://www.timeanddate.com/worldclock/fixedtime.html?iso=$ENCODED_TIMESTAMP"
          echo "## Benchmark check running at [$TIMESTAMP]($TIMESTAMP_LINK)" >> summary.text

          # Disable 'set -e' to prevent the script from exiting on non-zero exit codes
          set +e
          swift package -c release --disable-sandbox \
            --package-path Benchmarks \
            benchmark thresholds check \
            '${{ github.head_ref || github.ref_name }}' \
            --path "$PWD/Benchmarks/Thresholds/" \
            --no-progress \
            --format markdown \
            >> summary.text
          echo "exit-status=$?" >> "${GITHUB_OUTPUT}"
          set -e

          echo 'summary<<EOF' >> "${GITHUB_OUTPUT}"
          cat summary.text >> "${GITHUB_OUTPUT}"
          echo 'EOF' >> "${GITHUB_OUTPUT}"

      - name: Cache .build
        if: steps.restore-cache.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: Benchmarks/.build
          key: "swiftpm-benchmark-build-${{ runner.os }}-${{ github.event.pull_request.base.sha || github.event.after }}"

      - name: Construct comment
        id: pr-comment
        run: |
          cat summary.text

          EXIT_CODE='${{ steps.compare-benchmark.outputs.exit-status }}'

          echo 'content<<EOF' >> "${GITHUB_OUTPUT}"

          echo '## [Benchmark](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) Report' >> "${GITHUB_OUTPUT}"

          case "${EXIT_CODE}" in
              0)
                  echo '**âœ… Pull request has no significant performance differences âœ…**' >> "${GITHUB_OUTPUT}"
                  ;;
              1)
                  echo '**âŒ Pull request has significant performance differences ðŸ“Š**' >> "${GITHUB_OUTPUT}"
                  ;;
              2)
                  echo '**âŒ Pull request has significant performance regressions ðŸ“‰**' >> "${GITHUB_OUTPUT}"
                  ;;
              4)
                  echo '**âŒ Pull request has significant performance improvements ðŸ“ˆ**' >> "${GITHUB_OUTPUT}"
                  ;;
              *)
                  echo '**âŒ Benchmark comparison failed to complete properly with exit code $EXIT_CODE âŒ**' >> "${GITHUB_OUTPUT}"
                  ;;
          esac

          echo '<details>' >> "${GITHUB_OUTPUT}"
          echo '  <summary> Click to expand comparison result </summary>' >> "${GITHUB_OUTPUT}"
          echo '' >> "${GITHUB_OUTPUT}"
          echo '${{ steps.compare-benchmark.outputs.summary }}' >> "${GITHUB_OUTPUT}"
          echo '' >> "${GITHUB_OUTPUT}"
          echo '</details>' >> "${GITHUB_OUTPUT}"

          echo '' >> "${GITHUB_OUTPUT}"

          echo '<details>' >> "${GITHUB_OUTPUT}"
          echo '  <summary> Click to expand benchmark result </summary>' >> "${GITHUB_OUTPUT}"
          echo '' >> "${GITHUB_OUTPUT}"
          echo '${{ steps.read-benchmark.outputs.result }}' >> "${GITHUB_OUTPUT}"
          echo '' >> "${GITHUB_OUTPUT}"
          echo '</details>' >> "${GITHUB_OUTPUT}"

          echo 'EOF' >> "${GITHUB_OUTPUT}"

      - name: Output the comment as job summary
        run: echo '${{ steps.pr-comment.outputs.content }}' >> "${GITHUB_STEP_SUMMARY}"

      - name: Comment in PR
        if: startsWith(github.event_name, 'pull_request')
        uses: thollander/actions-comment-pull-request@v3
        with:
          message: ${{ steps.pr-comment.outputs.content }}
          comment-tag: benchmark-ci-comment

      - name: Exit with correct status
        run: |
          EXIT_CODE='${{ steps.compare-benchmark.outputs.exit-status }}'
          echo "Previous exit code was: $EXIT_CODE"
          exit $EXIT_CODE
