name: Deploy API documentation
description: Builds autogenerated API documentation for a repository and publishes it.

inputs:

runs:
  using: composite
  
  steps:
  
    - name: Check out latest SwiftDoc
      uses: actions/checkout@v2
      with:
        repository: SwiftDocOrg/swift-doc
        path: swift-doc
        fetch-depth: 1
    
    - name: Build latest SwiftDoc
      run: swift build -c release
        
    - name: Check out updated repository
      uses: actions/checkout@v2
      with:
        repository: ${{ github.repository }}
        path: updated-repo
    
    - name: Create output directory
      run: mkdir -p docs/$(basename ${{ github.repository }})/main
    
    - name: Build documentation for repository
      # It is simply unreal how difficult it is to get JSON parsing support on the commandline.
      # It's absurd to do an entire `apt-get install` just to get `jq`, and equally absurd to
      # write an entire Swift script to do one quick parse. Of course, this trick is ridiculous
      # too, but sadly, it works.
      working-directory: updated-repo
      run: |
        for module in $(
          echo 'package.products.compactMap { ($0 as? Product.Library)?.name }.forEach { print($0) }' |
          cat Package.swift - |
          swift -I/usr/lib/swift/pm/ManifestAPI -L/usr/lib/swift/pm/ManifestAPI -lPackageDescription -package-description-version 5.2.0 -
        ); do
          swift run --package-path ../swift-doc swift-doc \
            generate "Sources/${module}" \
            --module-name "${module}" \
            --output "../docs/$(basename ${{ github.repository }})/main/${module}" \
            --base-url "/$(basename ${{ github.repository }})/main/${module}" \
            --format html
        done
        chmod -R 0755 ../docs
    
    - name: Deploy updated files
      uses: appleboy/scp-action@master
      with:
        host: vapor.codes
        username: vapor
        key: ${{ secrets.VAPOR_CODES_SSH_KEY }}
        source: 'docs/'
        target: '/home/vapor/api-docs/public'
        strip_components: 1
